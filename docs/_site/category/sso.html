<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      02 Single Sign On &middot; Identity Service
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="category">

    <div id="sidebar">
  <header>
    <div>
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Identity Service
      </a>
    </div>
    <p class="lead">Single-Sign-On (SSO) and protect Web API for ASP.NET Core applications.</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  
    
  

  
    
      <a class="page-link "
          href="/about.html">About</a>
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  


  


  
    
  

  
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/installation.html">01 Installation</a>
    
  

  

  
    
      <a class="category-link  active"
          href="/category/sso.html">02 Single Sign On</a>
    
  

  
    
  

  
  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
    <span class="site-version">Currently v3</span>
  

  <hr>
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="page-title">02 Single Sign On</h1>
</header>
<div class="content">
  
  <h1 id="single-sign-on">Single-Sign-On</h1>

<p>Identity Service provides single-sign-on (SSO) to ASP.NET Core applications using Open ID connect.</p>

<h2 id="sample-client">Sample Client</h2>

<p>The sample client used for this article can be found at :</p>

<p><a href="https://github.com/rcladmin/identityservice/tree/master/SampleClient">ASP.NET Core Sample MVC Client</a></p>

<h2 id="add-a-client">Add a Client</h2>

<p>A client is a web application that you want to add SSO. Use the dashboard to add a client.</p>

<p><img src="https://raw.githubusercontent.com/rcladmin/identityservice/master/images/client/client_add.PNG" alt="placeholder" title="Add Client" /></p>

<h2 id="add-a-client-secret">Add a Client Secret</h2>

<p>Add a client secret. The secret will be hashed, so please write down the actual value to use in your web application.</p>

<p><img src="https://raw.githubusercontent.com/rcladmin/identityservice/master/images/client/client_secret.PNG" alt="placeholder" title="Add Client" /></p>

<h2 id="add-a-sign-in-uri">Add a Sign In Uri</h2>

<p>The Sign In Uri is the url of your web application with ‘/signin-oidc’ appended to the end.</p>

<p><img src="https://raw.githubusercontent.com/rcladmin/identityservice/master/images/client/client_sign_in.PNG" alt="placeholder" title="Add Client" /></p>

<h2 id="add-a-sign-out-uri">Add a Sign Out Uri</h2>

<p>The Sign Out Uri is the url of your web application with ‘/signout-callback-oidc’ appended to the end.</p>

<p><img src="https://raw.githubusercontent.com/rcladmin/identityservice/master/images/client/client_sign_out.PNG" alt="placeholder" title="Add Client" /></p>

<h2 id="add-authorization-to-your-aspnet-core-web-application">Add Authorization to your ASP.NET Core Web Application</h2>

<p>In the entire Startup.CS file in the sample is as follows :</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authentication</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authentication.Cookies</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authentication.OpenIdConnect</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Builder</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.IdentityModel.Protocols.OpenIdConnect</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IdentityModel.Tokens.Jwt</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.HttpOverrides</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">SampleClient</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">_Authority</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">_ClientId</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">_ClientSecret</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">_ApiUrl</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">_ApiScope</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">Startup</span><span class="p">(</span><span class="n">IConfiguration</span> <span class="n">configuration</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IConfiguration</span> <span class="n">Configuration</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_Authority</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">[</span><span class="s">"Authority"</span><span class="p">];</span>
            <span class="n">_ClientId</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">[</span><span class="s">"ClientId"</span><span class="p">];</span>
            <span class="n">_ClientSecret</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">[</span><span class="s">"ClientSecret"</span><span class="p">];</span>
            <span class="n">_ApiUrl</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">[</span><span class="s">"ApiUrl"</span><span class="p">];</span>
            <span class="n">_ApiScope</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">[</span><span class="s">"ApiScope"</span><span class="p">];</span>
           
            <span class="n">services</span><span class="p">.</span><span class="nf">AddAuthentication</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">options</span><span class="p">.</span><span class="n">DefaultScheme</span> <span class="p">=</span> <span class="n">CookieAuthenticationDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
                <span class="n">options</span><span class="p">.</span><span class="n">DefaultChallengeScheme</span> <span class="p">=</span> <span class="n">OpenIdConnectDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
            <span class="p">})</span>
           <span class="p">.</span><span class="nf">AddCookie</span><span class="p">()</span>
           <span class="p">.</span><span class="nf">AddOpenIdConnect</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span>
           <span class="p">{</span>
               <span class="n">o</span><span class="p">.</span><span class="n">SignInScheme</span> <span class="p">=</span> <span class="n">CookieAuthenticationDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">ResponseType</span> <span class="p">=</span> <span class="n">OpenIdConnectResponseType</span><span class="p">.</span><span class="n">CodeIdToken</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">Authority</span> <span class="p">=</span> <span class="n">_Authority</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">ClientId</span> <span class="p">=</span>  <span class="n">_ClientId</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">ClientSecret</span> <span class="p">=</span>  <span class="n">_ClientSecret</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">SaveTokens</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">SecurityTokenValidator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">JwtSecurityTokenHandler</span>
               <span class="p">{</span>
                   <span class="n">InboundClaimTypeMap</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;()</span>
               <span class="p">};</span>
               <span class="n">o</span><span class="p">.</span><span class="n">TokenValidationParameters</span><span class="p">.</span><span class="n">NameClaimType</span> <span class="p">=</span> <span class="s">"email"</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">GetClaimsFromUserInfoEndpoint</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">ClaimActions</span><span class="p">.</span><span class="nf">MapJsonKey</span><span class="p">(</span><span class="s">"Contributor"</span><span class="p">,</span> <span class="s">"Contributor"</span><span class="p">);</span>
           <span class="p">});</span>

            <span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">();</span>

            <span class="n">services</span><span class="p">.</span><span class="nf">AddAuthorization</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">options</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"Contributor"</span><span class="p">,</span> <span class="n">policy</span> <span class="p">=&gt;</span> <span class="n">policy</span><span class="p">.</span><span class="nf">RequireClaim</span><span class="p">(</span><span class="s">"Contributor"</span><span class="p">,</span> <span class="s">"True"</span><span class="p">));</span>
            <span class="p">});</span>

            <span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IHttpContextAccessor</span><span class="p">,</span> <span class="n">HttpContextAccessor</span><span class="p">&gt;();</span>
            <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">INavigationService</span><span class="p">,</span> <span class="n">NavigationService</span><span class="p">&gt;();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IHostingEnvironment</span> <span class="n">env</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">forwardingOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ForwardedHeadersOptions</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">ForwardedHeaders</span> <span class="p">=</span> <span class="n">ForwardedHeaders</span><span class="p">.</span><span class="n">XForwardedFor</span> <span class="p">|</span> <span class="n">ForwardedHeaders</span><span class="p">.</span><span class="n">XForwardedProto</span>
            <span class="p">};</span>
            <span class="n">forwardingOptions</span><span class="p">.</span><span class="n">KnownNetworks</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
            <span class="n">forwardingOptions</span><span class="p">.</span><span class="n">KnownProxies</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">UseForwardedHeaders</span><span class="p">(</span><span class="n">forwardingOptions</span><span class="p">);</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">((</span><span class="n">context</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Scheme</span> <span class="p">=</span> <span class="s">"https"</span><span class="p">;</span>
                <span class="k">return</span> <span class="nf">next</span><span class="p">();</span>
            <span class="p">});</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">UsePathBase</span><span class="p">(</span><span class="s">"/sampleclient"</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="nf">IsDevelopment</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">app</span><span class="p">.</span><span class="nf">UseBrowserLink</span><span class="p">();</span>
                <span class="n">app</span><span class="p">.</span><span class="nf">UseDeveloperExceptionPage</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">app</span><span class="p">.</span><span class="nf">UseExceptionHandler</span><span class="p">(</span><span class="s">"/Home/Error"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">app</span><span class="p">.</span><span class="nf">UseStaticFiles</span><span class="p">();</span>

            <span class="n">app</span><span class="p">.</span><span class="nf">UseAuthentication</span><span class="p">();</span>

            <span class="n">app</span><span class="p">.</span><span class="nf">UseMvc</span><span class="p">(</span><span class="n">routes</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">:</span> <span class="s">"default"</span><span class="p">,</span>
                    <span class="n">template</span><span class="p">:</span> <span class="s">"{controller=Home}/{action=Index}/{id?}"</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The authorization service is configured in the following section :</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">services</span><span class="p">.</span><span class="nf">AddAuthentication</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">options</span><span class="p">.</span><span class="n">DefaultScheme</span> <span class="p">=</span> <span class="n">CookieAuthenticationDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
                <span class="n">options</span><span class="p">.</span><span class="n">DefaultChallengeScheme</span> <span class="p">=</span> <span class="n">OpenIdConnectDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
            <span class="p">})</span>
           <span class="p">.</span><span class="nf">AddCookie</span><span class="p">()</span>
           <span class="p">.</span><span class="nf">AddOpenIdConnect</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span>
           <span class="p">{</span>
               <span class="n">o</span><span class="p">.</span><span class="n">SignInScheme</span> <span class="p">=</span> <span class="n">CookieAuthenticationDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">ResponseType</span> <span class="p">=</span> <span class="n">OpenIdConnectResponseType</span><span class="p">.</span><span class="n">CodeIdToken</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">Authority</span> <span class="p">=</span> <span class="n">_Authority</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">ClientId</span> <span class="p">=</span>  <span class="n">_ClientId</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">ClientSecret</span> <span class="p">=</span>  <span class="n">_ClientSecret</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">SaveTokens</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">SecurityTokenValidator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">JwtSecurityTokenHandler</span>
               <span class="p">{</span>
                   <span class="n">InboundClaimTypeMap</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;()</span>
               <span class="p">};</span>
               <span class="n">o</span><span class="p">.</span><span class="n">TokenValidationParameters</span><span class="p">.</span><span class="n">NameClaimType</span> <span class="p">=</span> <span class="s">"email"</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">GetClaimsFromUserInfoEndpoint</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
               <span class="n">o</span><span class="p">.</span><span class="n">ClaimActions</span><span class="p">.</span><span class="nf">MapJsonKey</span><span class="p">(</span><span class="s">"Contributor"</span><span class="p">,</span> <span class="s">"Contributor"</span><span class="p">);</span>
           <span class="p">});</span>

            <span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">();</span>

            <span class="n">services</span><span class="p">.</span><span class="nf">AddAuthorization</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">options</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"Contributor"</span><span class="p">,</span> <span class="n">policy</span> <span class="p">=&gt;</span> <span class="n">policy</span><span class="p">.</span><span class="nf">RequireClaim</span><span class="p">(</span><span class="s">"Contributor"</span><span class="p">,</span> <span class="s">"True"</span><span class="p">));</span>
            <span class="p">});</span>
</code></pre></div></div>

<p>The OpenIdConnect authorization is configured. The Client ID and Client Secret is stored in configuration. The values are the same as what we set earlier in the Identity Service dashboard. The ‘Authority’ is the url of the Identity Service application. The following is an example of the values :</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"Authority"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://sampleidsvc.azurewebsites.net/identitysvc"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"ClientId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sample-client"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"ClientSecret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1234"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"ApiUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://rclsampleapi.azurewebsites.net"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"ApiScope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sampleapi-full"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The following line in the ‘Configure’ method enables Authentication in your application.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">app</span><span class="p">.</span><span class="nf">UseAuthentication</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="setting-up-the-account-controller">Setting up the Account Controller</h2>

<p>The Account controller is used to establish the login action and logout action in your application.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authentication</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authentication.Cookies</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authentication.OpenIdConnect</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authorization</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">SellingService.Controllers</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AccountController</span> <span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Logout</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">HttpContext</span><span class="p">.</span><span class="nf">SignOutAsync</span><span class="p">(</span><span class="n">CookieAuthenticationDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">HttpContext</span><span class="p">.</span><span class="nf">SignOutAsync</span><span class="p">(</span><span class="n">OpenIdConnectDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Login</span><span class="p">(</span><span class="kt">string</span> <span class="n">ReturnUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">ReturnUrl</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="nf">Redirect</span><span class="p">(</span><span class="n">ReturnUrl</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nf">RedirectToAction</span><span class="p">(</span><span class="s">"Index"</span><span class="p">,</span> <span class="s">"Home"</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">AccessDenied</span><span class="p">(</span><span class="kt">string</span> <span class="n">ReturnUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="login--log-out-links">Login / Log out links</h2>

<p>The _LoginPartialView provides the login and lout links.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@model String
@{

    string registerUrl = $"{Startup._Authority}/Account/Register?returnUrl={Model}";
}
@if (User.Identity.IsAuthenticated == true)
{
    <span class="nt">&lt;form</span> <span class="na">asp-area=</span><span class="s">""</span> <span class="na">asp-controller=</span><span class="s">"Account"</span> <span class="na">asp-action=</span><span class="s">"Logout"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">id=</span><span class="s">"logoutForm"</span> <span class="na">class=</span><span class="s">"navbar-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;li&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>@User.Identity.Name<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li&gt;</span>
                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-link navbar-btn navbar-link"</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/button&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
}
else
{
    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"@registerUrl"</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">asp-area=</span><span class="s">""</span> <span class="na">asp-controller=</span><span class="s">"Account"</span> <span class="na">asp-action=</span><span class="s">"Login"</span> <span class="na">asp-route-ReturnUrl=</span><span class="s">"@Model"</span><span class="nt">&gt;</span>Log In<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
}
</code></pre></div></div>

<p>The _LoginPartalView is added to the layout page to display the login links in the top menu.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@inject INavigationService NavService

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>@ViewData["Title"] - Sample Client<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"~/lib/bootstrap/dist/css/bootstrap.css"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"~/css/site.css"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-default navbar-fixed-top"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">".navbar-collapse"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Toggle navigation<span class="nt">&lt;/span&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;/button&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">asp-area=</span><span class="s">""</span> <span class="na">asp-controller=</span><span class="s">"Home"</span> <span class="na">asp-action=</span><span class="s">"Index"</span> <span class="na">class=</span><span class="s">"navbar-brand"</span><span class="nt">&gt;</span>Sample Client<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-collapse collapse"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">asp-area=</span><span class="s">""</span> <span class="na">asp-controller=</span><span class="s">"Home"</span> <span class="na">asp-action=</span><span class="s">"Index"</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;/ul&gt;</span>
                @await Html.PartialAsync("_LoginPartial", NavService.GetAbsoluteUrl());
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container body-content"</span><span class="nt">&gt;</span>
        @RenderBody()
        <span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;footer&gt;</span>
            <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> 2018 - Sample Client<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/footer&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"~/lib/jquery/dist/jquery.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"~/lib/bootstrap/dist/js/bootstrap.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    @RenderSection("Scripts", required: false)
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>This line of code is responsible for displaying the login controls</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">@await</span> <span class="n">Html</span><span class="p">.</span><span class="nf">PartialAsync</span><span class="p">(</span><span class="s">"_LoginPartial"</span><span class="p">,</span> <span class="n">NavService</span><span class="p">.</span><span class="nf">GetAbsoluteUrl</span><span class="p">());</span>
</code></pre></div></div>

<p>You will notice that we injected a ‘NavigationService’, the reason for this is to return the user to your application after they login (or register a new account) in Identity Service. The code for the NavigationSrvice is shown below :</p>

<h3 id="inavigationservice-interface">INavigationService Interface</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">SampleClient</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">INavigationService</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="nf">GetAbsoluteUrl</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="navigationservice-class">NavigationService Class</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Http</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">SampleClient</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">NavigationService</span> <span class="p">:</span> <span class="n">INavigationService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHttpContextAccessor</span> <span class="n">_request</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">NavigationService</span><span class="p">(</span><span class="n">IHttpContextAccessor</span> <span class="n">request</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_request</span> <span class="p">=</span> <span class="n">request</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetAbsoluteUrl</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">_request</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="nf">GetAbsoluteUrl</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="navigationservice-extension">NavigationService Extension</h3>

<p>This is used to extend ‘HttpContext.Request’ in the ‘NavigationService’ class.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Http</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">SampleClient</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">HttpRequestExtensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetAbsoluteUrl</span><span class="p">(</span><span class="k">this</span> <span class="n">HttpRequest</span> <span class="n">request</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">httpContext</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">;</span>
            <span class="k">return</span> <span class="s">$"</span><span class="p">{</span><span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Scheme</span><span class="p">}</span><span class="s">://</span><span class="p">{</span><span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Host</span><span class="p">}{</span><span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span><span class="p">}{</span><span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">QueryString</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>




<ul class="posts-list">
  
  
</ul>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
