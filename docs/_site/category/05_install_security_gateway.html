<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      05 Install Security Gateway &middot; Microservices with AKS
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="category">

    <div id="sidebar">
  <header>
    <div>
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Microservices with AKS
      </a>
    </div>
    <p class="lead">Create microservices with Azure Kubernetes Service</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/about.html">About</a>
    
  

  
    
  

  

  
    
  


  


  
    
      <a class="category-link "
          href="/category/01_install_aks.html">01 Install Azure Kubernetes Service</a>
    
  

  
    
      <a class="category-link "
          href="/category/02_install_helm.html">02 Install Helm on Windows</a>
    
  

  
    
      <a class="category-link "
          href="/category/03_install_ingress.html">03 Install an Ingress Controller</a>
    
  

  
    
      <a class="category-link "
          href="/category/04_install_cert_mgr.html">04 Install HTTPS Certificates</a>
    
  

  
    
      <a class="category-link  active"
          href="/category/05_install_security_gateway.html">05 Install Security Gateway</a>
    
  

  
    
      <a class="category-link "
          href="/category/06_api_services.html">06 API Services</a>
    
  

  
    
      <a class="category-link "
          href="/category/07_messaging_service.html">07 Messaging Service</a>
    
  

  
    
      <a class="category-link "
          href="/category/08_composite_ui.html">08 Composite UI Frontend</a>
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  <hr>
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="page-title">05 Install Security Gateway</h1>
</header>
<div class="content">
  
  <h2 id="security-gateway-with-identity-service">Security Gateway With Identity Service</h2>

<p>Identity Service runs as a separate web application and provides Single-Sign-On (SSO) for ASP.NET Core applications using Open ID connect. It is hosted in a docker container in an Azure Container Services (AKS) Linux cluster.</p>

<p>It can be used as a gateway in a micro-services architecture to provide identity services and to secure web APIs. Identity Service uses the Client Credentials flow to protect ASP.NET Core Web APIs.</p>

<p>You can also use it to provide authorized access to pages in you web application such as “Admin” pages. It provides a simple mechanism to manage users, roles and claims for ASP.NET Core Identity.</p>

<p>All the tasks carried out in Identity Service are done through a simple and intuitive web UI dashboard.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Identity Service requires the following:</p>

<ul>
  <li>Azure SQL Database</li>
  <li>SendGrid Email service</li>
</ul>

<h3 id="azure-sql-database">Azure SQL Database</h3>

<p>Identity Service stores its data in a SQL Database. Install an Azure SQL Database in your azure account or use an existing database and copy the following for use later on :</p>

<ul>
  <li>SQL Server name</li>
  <li>SQL Server database name</li>
  <li>SQL Server login username</li>
  <li>SQL Server login password</li>
</ul>

<p>For detailed instructions on creating an Azure SQL Database, refer to the  <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-get-started-portal">Azure SQL Server Documentation</a></p>

<h3 id="sendgrid-email-service">SendGrid Email Service</h3>

<p>Identity Service requires verification of emails when a user first registers. We use the SendGrid email service for this. Install SendGrid in your Azure account or use an existing installation and copy the <strong>SendGrid API Key</strong> for use later on. For detailed instructions, refer to the  <a href="https://docs.microsoft.com/en-us/azure/sendgrid-dotnet-how-to-send-email">Azure Send Grid Documentation</a></p>

<h2 id="install-identity-service">Install Identity Service</h2>

<p>Create a file called ‘identityservice.yaml’ and add the following code. Replace the «place holder text» with the data you copied for the SQL Database and SendGrid Service earlier in this article. You will also need to include an Admin Email address.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">identitysvc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">identitysvc</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">rcladmin/identitysvc3:125</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">identitysvc</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">80</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ASPNETCORE_ENVIRONMENT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">Production</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DatabaseConnection</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">Server=tcp:&lt;&lt;your-sql-server-name&gt;&gt;,1433;Initial Catalog=&lt;&lt;your-db-name&gt;&gt;;Persist Security Info=False;User ID=&lt;&lt;your-sql-server-username&gt;&gt;;Password=&lt;&lt;your-sql-server-password&gt;&gt;;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;</span>       
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SendGridAPIKey</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;&lt;your-sendgrid-api-key&gt;&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AdminUserName</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;&lt;your-admin-email&gt;&gt;</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">identitysvc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">80</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">identitysvc</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>        
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">identitysvc-ingress</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">nginx.ingress.kubernetes.io/rewrite-target</span><span class="pi">:</span> <span class="s">/</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">tls</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">&lt;&lt;your-dns-name&gt;&gt;</span>
    <span class="na">secretName</span><span class="pi">:</span> <span class="s">acme-crt-secret</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">&lt;&lt;your-dns-name&gt;&gt;</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/identitysvc</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">serviceName</span><span class="pi">:</span> <span class="s">identitysvc</span>
          <span class="na">servicePort</span><span class="pi">:</span> <span class="s">80</span>
</code></pre></div></div>

<p>To install Identity Service, CD into the folder where you saved the file and run the following command</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f identityservice.yaml
</code></pre></div></div>

<p>The ingress rules will allow the load balancer to route all requests with path /identitysvc to identity service. The site will also be run with HHTPS.</p>

<p>Navigate to the site at https://«your-dns-name»/identitysvc</p>

<p><img src="https://raw.githubusercontent.com/rcl-microservices-aks/documentation/master/images/identity/identity-1.PNG" alt="placeholder" title="Image" /></p>




<ul class="posts-list">
  
  
</ul>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
