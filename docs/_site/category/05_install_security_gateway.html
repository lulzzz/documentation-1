<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      05 Install Security Gateway &middot; Microservices
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="category">

    <div id="sidebar">
  <header>
    <div>
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Microservices
      </a>
    </div>
    <p class="lead">Microservices with Azure, ASP.NET and Xamarin</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  
<!--
  


  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  


-->
  


  
    
      <a class="category-link "
          href="/category/01_install_aks.html">01 Create Azure Kubernetes Service</a>
    
  

  
    
      <a class="category-link "
          href="/category/02_install_helm.html">02 Installing Helm on Windows</a>
    
  

  
    
      <a class="category-link "
          href="/category/03_install_ingress.html">03 Install an Ingress Controller</a>
    
  

  
    
      <a class="category-link "
          href="/category/04_install_cert_mgr.html">04 Install HTTPS Certificates</a>
    
  

  
    
      <a class="category-link  active"
          href="/category/05_install_security_gateway.html">05 Install Security Gateway</a>
    
  

  
    
      <a class="category-link "
          href="/category/06_api_services.html">06 API Services</a>
    
  

  
    
      <a class="category-link "
          href="/category/07_messaging_service.html">07 Messaging Service</a>
    
  

  
    
      <a class="category-link "
          href="/category/08_composite_ui.html">08 Composite UI Frontend</a>
    
  

  
    
  

  
    
  

  

  
    
  

  
  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  <hr>
  <nav id="sidebar-icon-links">
  
    <a id="github-link"
       class="icon" title="Github Project" aria-label="Github Project"
       href="https://github.com/rcl-microservices-aks">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

    </a>
    <!--
    <a id="github-download-link"
       class="icon" title="Download" aria-label="Download"
       href="https://github.com/rcl-microservices-aks/archive/v3.zip">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
    -->
  

   <!--
  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
  -->
  <!-- Optional additional links to insert for icons links -->
</nav>
  <p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="page-title">05 Install Security Gateway</h1>
</header>
<div class="content">
  
  <h2 id="security-gateway-with-identity-service">Security Gateway With Identity Service</h2>

<p>Identity Service runs as a separate web application and provides Single-Sign-On (SSO) for ASP.NET Core applications using Open ID connect. It is hosted in a docker container in an Azure Container Services (AKS) Linux cluster.</p>

<p>It can be used as a gateway in a micro-services architecture to provide identity services and to secure web APIs. Identity Service uses the Client Credentials flow to protect ASP.NET Core Web APIs.</p>

<p>You can also use it to provide authorized access to pages in you web application such as “Admin” pages. It provides a simple mechanism to manage users, roles and claims for ASP.NET Core Identity.</p>

<p>All the tasks carried out in Identity Service are done through a simple and intuitive web UI dashboard.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Identity Service requires the following:</p>

<ul>
  <li>Azure SQL Database</li>
  <li>SendGrid Email service</li>
</ul>

<h3 id="azure-sql-database">Azure SQL Database</h3>

<p>Identity Service stores its data in a SQL Database. Install an Azure SQL Database in your azure account or use an existing database and copy the following for use later on :</p>

<ul>
  <li>SQL Server name</li>
  <li>SQL Server database name</li>
  <li>SQL Server login username</li>
  <li>SQL Server login password</li>
</ul>

<p>For detailed instructions on creating an Azure SQL Database, refer to the  <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-get-started-portal">Azure SQL Server Documentation</a></p>

<h3 id="sendgrid-email-service">SendGrid Email Service</h3>

<p>Identity Service requires verification of emails when a user first registers. We use the SendGrid email service for this. Install SendGrid in your Azure account or use an existing installation and copy the <strong>SendGrid API Key</strong> for use later on. For detailed instructions, refer to the  <a href="https://docs.microsoft.com/en-us/azure/sendgrid-dotnet-how-to-send-email">Azure Send Grid Documentation</a></p>

<h2 id="install-identity-service">Install Identity Service</h2>

<p>Create a file called ‘identityservice.yaml’ and add the following code. Replace the «place holder text» with the data you copied for the SQL Database and SendGrid Service earlier in this article. You will also need to include an Admin Email address.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">identitysvc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">identitysvc</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">rcladmin/identitysvc3:125</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">identitysvc</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">80</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ASPNETCORE_ENVIRONMENT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">Production</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DatabaseConnection</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">Server=tcp:&lt;&lt;your-sql-server-name&gt;&gt;,1433;Initial Catalog=&lt;&lt;your-db-name&gt;&gt;;Persist Security Info=False;User ID=&lt;&lt;your-sql-server-username&gt;&gt;;Password=&lt;&lt;your-sql-server-password&gt;&gt;;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;</span>       
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SendGridAPIKey</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;&lt;your-sendgrid-api-key&gt;&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">AdminUserName</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;&lt;your-admin-email&gt;&gt;</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">identitysvc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">80</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">identitysvc</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>        
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">identitysvc-ingress</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">nginx.ingress.kubernetes.io/rewrite-target</span><span class="pi">:</span> <span class="s">/</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">tls</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">&lt;&lt;your-dns-name&gt;&gt;</span>
    <span class="na">secretName</span><span class="pi">:</span> <span class="s">acme-crt-secret</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">&lt;&lt;your-dns-name&gt;&gt;</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/identitysvc</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">serviceName</span><span class="pi">:</span> <span class="s">identitysvc</span>
          <span class="na">servicePort</span><span class="pi">:</span> <span class="s">80</span>
</code></pre></div></div>

<p>To install Identity Service, CD into the folder where you saved the file and run the following command</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f identityservice.yaml
</code></pre></div></div>

<p>The ingress rules will allow the load balancer to route all requests with path /identitysvc to identity service. The site will also be run with HHTPS.</p>

<p>Navigate to the site at https://«your-dns-name»/identitysvc</p>

<p><img src="https://raw.githubusercontent.com/rcl-microservices-aks/documentation/master/images/identity/identity-1.PNG" alt="placeholder" title="Image" /></p>

<h3 id="next-steps">Next Steps</h3>

<p>The other article in this website will walk you through installing Web API services in the AKS cluster.</p>

<p>Next Article : <a href="/category/06_api_services">Installing Web API Services</a></p>





  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://localhost:4000/category/05_install_security_gateway.html";
    this.page.identifier = "" ||
                           "http://localhost:4000/category/05_install_security_gateway.html";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//rcl-micro-service.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>


</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
